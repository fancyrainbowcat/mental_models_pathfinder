<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Basic Bootstrap Template</title>
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename="css/style.css")}}">
    <!-- Optional Bootstrap theme -->
    <link rel="stylesheet" href="{{ url_for('static', filename="css/bootstrap-theme.min.css")}}">
</head>
<body >
    <h1>Measuring Team Mental Models</h1>
    <h2>Please indicate for each pair of statements how related they are to each other for you on a scale from 1 - 5.</h2>
    <p> <b>1</b> meaning the statements are highly <b>negatively</b> correlated, a high degree of one requires a low degree of the other (e.g. "The sun is shining" and "It's nighttime") <br> <b>5</b> meaning they are highly <b>positively</b> correlated, a high degree of one requires a high degree of the other (e.g. "The sun is shining" and "It's daytime")</p>

    <select required id="team_number" onchange="changed_team_name()">
            <option value=""
            hidden
            >Please Select</option>
            <option value="volvo">Volvo</option>
            <option value="saab">Saab</option>
            <option value="mercedes">Mercedes</option>
            <option value="audi">Audi</option>
    </select>
    <script src="{{ url_for('static', filename="js/jquery-3.3.1.min.js")}}"></script>
    <script src="{{ url_for('static', filename="js/bootstrap.min.js")}}"></script>
    <div class="row">
        <div class="column left">
            <div id="current_statement">Test</div>
        </div>
        <div class="column middle">
            <div class="wrap" id="likert_box">
                        <form action= ""  method="post" id="form1">
                        </form>
            <input type="button" id="submit" onclick="return submit_likert()" value="Next">  
            <div id="finished"><h3>Finished :)</h3></div>

            </div>         
        </div>
    </div>

    <script>
        var statements = ["Team members work well together","Team members often disagree with each other on issues faced by the team","Team members trust each other","Team members communicate openly with each other","Team members agree on decisions made in the team","Team members accept decisions made by the leader","Team mebers interact with one another outside official settings","Team members back each other up in carrying out team tasks","Team members are similar to each other (e.g. personality, temperament, and abilities","Team members are aware of other team members' abilities","Team members are aware of other team members' personal backgrounds (e.g. family background, hobbies and habits)","Team members know other team members' family members","Team members treat each other as friends","The team is highly effective","Team members communicate frequently with each other at formal occasions (e.g. team meetings","Team members communicate frequently with each other at informal occasions (e.g. in the hallways)"];
        var iterator = statements.length - 1;
        var list = "";
        var uuid = 0;
        var team_id = 0;

        function changed_team_name() 
        {
            team_id = document.getElementById("team_number").value;
        }

        function create_likert(id) {
            var likert = document.createElement("span");
            likert.setAttribute('class',"answers");

            var disagree = document.createElement("span");
            disagree.innerHTML = "Strongly Disagree";

            var agree = document.createElement("span");
            agree.innerHTML = "Strongly Agree";

            var statement = document.createElement("div");
            statement.setAttribute('id', "statement_"+id);
            statement.setAttribute('class', "statement_box");
            statement.innerHTML = "";

            var newline = document.createElement("span");
            newline.innerHTML = "<br> <br>";

            var radios = new Array();
            for(i = 0; i < 5; i++) {
                radios[i] = document.createElement("input");
                radios[i].required = true;
                radios[i].setAttribute('type',"radio");
                radios[i].setAttribute('name',id);
                radios[i].setAttribute('value',i);
                radios[i].setAttribute('id',id+'_'+i.toString());
            }

            likert.appendChild(disagree);
            for(i = 0; i < 5; i++) {
                likert.appendChild(radios[i]);
            }
            likert.appendChild(agree);
            likert.appendChild(statement);
            likert.appendChild(newline);

            return likert;
        }

        function evaluate_likert(){
            var ems = document.getElementById("form1").elements;
            var likert_dict = [];

            likert_dict.push({'uuid': user_id})
        
            for(var i=0, mx=ems.length;i<mx;i++){
                if(ems[i].checked){
                    dst = Number(ems[i].name.replace('q',''));
                    likert_dict.push({'name': ems[i].name,
                                       'value': ems[i].value,
                                       'src': iterator+1,
                                       'dst': dst})
                    ems[i].checked = false;
                }		
            }

            $.ajax({
                url: '/index',
                data: JSON.stringify(likert_dict),
                type: 'POST',
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function(response) {
                    console.log(response);
                },
                error: function(error) {
                    console.log(error);
                }
            });
             
        }      

        function send_submit() {
            var submit_dict = [];

            submit_dict.push({"uuid": user_id})
            submit_dict.push({"result": "success"})

            $.ajax({
                url: '/submit',
                data: JSON.stringify(submit_dict),
                type: 'POST',
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function(response) {
                    console.log(response);
                },
                error: function(error) {
                    console.log(error);
                }
            });
        }

        function send_uuid() {
            var uuid_json = [];
            uuid_json.push({'uuid': user_id})

            $.ajax({
                url: '/index',
                data: JSON.stringify(uuid_json),
                type: 'POST',
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function(response) {
                    console.log(response);
                },
                error: function(error) {
                    console.log(error);
                }
            });
        }

        function send_team()
        {
            var team_name_json = [];
            team_name_json.push({'uuid': user_id})
            team_name_json.push({'team_id': team_id})

            $.ajax({
                url: '/team',
                data: JSON.stringify(team_name_json),
                type: 'POST',
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function(response) {
                    console.log(response);
                },
                error: function(error) {
                    console.log(error);
                }
            });
        }

        function validate_team_id() {
            if(team_id == 0) {
                return false;
            }
            return true;
        }

        function validate_likert(id) {
            var radio = $('input:radio[name="q'+likert_i.toString()+'"]:checked');
                if(radio.length == 0)//no buttons selected
                {
                    return false;
                }
            return true;
        }

        // user hit the next/submit button
        function submit_likert() {
            // check for every likert scale if any radio button was selected
            for (likert_i = 0; likert_i < iterator+1; likert_i ++) { 
                id = "q"+likert_i.toString();

                if(!validate_likert(id)) {
                    alert("You forgot to select statement: \""+statements[likert_i]+"\"");
                    return false;

                }
            }        

            if(!validate_team_id()) {
                alert("You forgot to select your team");
                return false;
            }

            next_statement();
        }
        
        function next_statement() {
            // evaluate results and move on to next statement
            if(iterator >= 0) {
                // send previous lickert data to backend
                evaluate_likert();
                
                // clear previous likert scales
                document.getElementById("current_statement").innerHTML = statements[iterator];
                document.getElementById("form1").innerHTML = "";

                // create new likert scales
                for (likert_i = 0; likert_i < iterator; likert_i ++) { 
                    var id = 'q'+likert_i.toString();
                    document.getElementById("form1").appendChild(create_likert(id));
                    document.getElementById("statement_"+id).innerHTML = statements[likert_i];
                }

                iterator = iterator - 1;
            }

            // last statement, change button name
            if(iterator == 0) {
                document.getElementById("submit").value = 'Submit';
            }

            // last statement submitted, finish off
            if(iterator == -1) {
                document.getElementById("current_statement").innerHTML = '';
                document.getElementById("finished").style.display = 'block';
                document.getElementById("submit").style.display = 'none';

                send_team();
                send_submit();
            }
        }


        // Generate unique user id for current session
        function get_uuid() {
            function s4() {
                return Math.floor((1 + Math.random()) * 0x10000)
                .toString(16)
                .substring(1);
            }
            return s4() + s4() + '-' + s4() + '-' + s4() + '-' + s4() + '-' + s4() + s4() + s4();
        }

        // Called once DOM loaded
        function init() {
            // give user an unique ID
            user_id = get_uuid();
            next_statement();
            send_uuid();
        }

        if(document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            //The DOMContentLoaded event has already fired. Just run the code.
            init();
        }
        
    </script>
</body>
</html>